# ðŸ” PR Checks - ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ¸ ÐºÐ¾Ð´Ð° Ð¿Ñ€Ð¸ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ð¸ Pull Request Ð¸ Ð¿ÑƒÑˆÐµ Ð² Ð¾ÑÐ½Ð¾Ð²Ð½Ñ‹Ðµ Ð²ÐµÑ‚ÐºÐ¸
# Ð’Ñ‹Ð¿Ð¾Ð»Ð½ÑÐµÑ‚ÑÑ ÐºÐ¾Ð¼Ð¿Ð¸Ð»ÑÑ†Ð¸Ñ, Ð²Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ñ (checkstyle), Ñ‚ÐµÑÑ‚Ñ‹ Ð¸ Ð¿Ð¾ÐºÑ€Ñ‹Ñ‚Ð¸Ðµ
# Ð¡Ñ€Ð°Ð±Ð°Ñ‚Ñ‹Ð²Ð°ÐµÑ‚ Ð½Ð° PR Ð² Ð¾ÑÐ½Ð¾Ð²Ð½Ñ‹Ðµ Ð²ÐµÑ‚ÐºÐ¸ Ð˜ Ð½Ð° Ð¿Ñ€ÑÐ¼Ð¾Ð¹ Ð¿ÑƒÑˆ Ð² ÑÑ‚Ð¸ Ð²ÐµÑ‚ÐºÐ¸
name: Build

on:
  # PR Ð² Ð¾ÑÐ½Ð¾Ð²Ð½Ñ‹Ðµ Ð²ÐµÑ‚ÐºÐ¸
  pull_request:
    branches:
      - main
      - master
      - develop
      - 'dev/**'
      - 'release/**'

  # ÐŸÑ€ÑÐ¼Ð¾Ð¹ Ð¿ÑƒÑˆ Ð² Ð¾ÑÐ½Ð¾Ð²Ð½Ñ‹Ðµ Ð²ÐµÑ‚ÐºÐ¸
  push:
    branches:
      - main
      - master
      - develop
      - 'dev/**'
      - 'release/**'

jobs:
  # ðŸ“‹ Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾ ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ð¸
  event-info:
    runs-on: ubuntu-latest
    outputs:
      event-type: ${{ steps.info.outputs.event-type }}
      target-branch: ${{ steps.info.outputs.target-branch }}
      source-branch: ${{ steps.info.outputs.source-branch }}

    steps:
      - name: Event Information
        id: info
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "event-type=pull_request" >> $GITHUB_OUTPUT
            echo "target-branch=${{ github.base_ref }}" >> $GITHUB_OUTPUT
            echo "source-branch=${{ github.head_ref }}" >> $GITHUB_OUTPUT
            echo "Event: Pull Request"
            echo "Target branch: ${{ github.base_ref }}"
            echo "Source branch: ${{ github.head_ref }}"
            echo "PR number: ${{ github.event.number }}"
          else
            echo "event-type=push" >> $GITHUB_OUTPUT
            echo "target-branch=${{ github.ref_name }}" >> $GITHUB_OUTPUT
            echo "source-branch=${{ github.ref_name }}" >> $GITHUB_OUTPUT
            echo "Event: Direct Push"
            echo "Branch: ${{ github.ref_name }}"
            echo "Commit: ${{ github.sha }}"
          fi

  # âš¡ Ð‘Ñ‹ÑÑ‚Ñ€Ñ‹Ðµ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ - ÐºÐ¾Ð¼Ð¿Ð¸Ð»ÑÑ†Ð¸Ñ Ñ Ð²Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸ÐµÐ¹ (checkstyle Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÑÐµÑ‚ÑÑ Ð² Ñ„Ð°Ð·Ðµ validate)
  quick-checks:
    runs-on: ubuntu-latest
    needs: event-info

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 24
        uses: actions/setup-java@v4
        with:
          java-version: '24'
          distribution: 'temurin'
          cache: maven

      # ðŸ—ï¸ ÐšÐ¾Ð¼Ð¿Ð¸Ð»ÑÑ†Ð¸Ñ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð° Ñ Ð¿Ñ€Ð¾Ñ„Ð¸Ð»ÐµÐ¼ (checkstyle Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÑÐµÑ‚ÑÑ Ð² Ñ„Ð°Ð·Ðµ validate)
      - name: Compile with validation
        run: |
          echo "::group::ðŸ“¦ Compiling project with validation (includes Checkstyle)"
          mvn clean compile -P prod-like-track -B
          echo "::endgroup::"
        # ÐšÐ¾Ð¼Ð¿Ð¸Ð»ÑÑ†Ð¸Ñ Ñ Ð¿Ñ€Ð¾Ñ„Ð¸Ð»ÐµÐ¼ prod-like-track Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ Ð²ÐºÐ»ÑŽÑ‡Ð°ÐµÑ‚ checkstyle Ð² Ñ„Ð°Ð·Ðµ validate

      # ðŸ“Š Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ðµ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ð¾Ð² checkstyle (ÐµÑÐ»Ð¸ ÐµÑÑ‚ÑŒ Ð¾ÑˆÐ¸Ð±ÐºÐ¸)
      - name: Upload Checkstyle results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: checkstyle-results
          path: '**/target/checkstyle-result.xml'
          if-no-files-found: ignore

  # ðŸ§ª Ð¢ÐµÑÑ‚Ñ‹ Ð¸ Ð¿Ð¾ÐºÑ€Ñ‹Ñ‚Ð¸Ðµ
  tests-and-coverage:
    runs-on: ubuntu-latest
    needs: [event-info, quick-checks]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 24
        uses: actions/setup-java@v4
        with:
          java-version: '24'
          distribution: 'temurin'
          cache: maven

      # ðŸ§ª Ð—Ð°Ð¿ÑƒÑÐº Ñ‚ÐµÑÑ‚Ð¾Ð² Ñ Ð¿Ð¾ÐºÑ€Ñ‹Ñ‚Ð¸ÐµÐ¼ (Ð°Ð³Ñ€ÐµÐ³Ð°Ñ†Ð¸Ñ Ð¿Ñ€Ð¾Ð¸ÑÑ…Ð¾Ð´Ð¸Ñ‚ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ Ð² Ñ„Ð°Ð·Ðµ verify)
      - name: Run tests with coverage
        run: |
          echo "::group::ðŸ§ª Running tests with JaCoCo coverage (aggregation included)"
          mvn clean verify -P prod-like-track -B \
            -Djacoco.halt.on.failure=false
          echo "::endgroup::"
        # verify Ñ„Ð°Ð·Ð° Ñ Ð¿Ñ€Ð¾Ñ„Ð¸Ð»ÐµÐ¼ prod-like-track ÑƒÐ¶Ðµ Ð²ÐºÐ»ÑŽÑ‡Ð°ÐµÑ‚ jacoco:report-aggregate

      # ðŸ“‹ ÐžÑ‚Ñ‡ÐµÑ‚ Ð¾ Ñ‚ÐµÑÑ‚Ð°Ñ… Ð¿ÑƒÐ±Ð»Ð¸ÐºÑƒÐµÑ‚ÑÑ Ð² Ð²Ð¸Ð´Ðµ ÐºÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð°Ñ€Ð¸ÐµÐ² Ð¸ Ð°Ð½Ð½Ð¾Ñ‚Ð°Ñ†Ð¸Ð¹ Ðº PR/ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚Ñƒ
      - name: Publish Test Report
        uses: dorny/test-reporter@v1
        if: always()
        with:
          name: Maven Tests Report
          token: ${{ secrets.GITHUB_TOKEN }}
          path: '**/target/surefire-reports/*.xml,**/target/failsafe-reports/*.xml'
          reporter: java-junit
          fail-on-error: false


      # ðŸ“ˆ ÐžÑ‚Ð¿Ñ€Ð°Ð²ÐºÐ° Ð¿Ð¾ÐºÑ€Ñ‹Ñ‚Ð¸Ñ Ð² Codecov
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: ./target/site/jacoco-aggregate/jacoco.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false
          verbose: true

      # ðŸ’¬ ÐšÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð°Ñ€Ð¸Ð¹ Ñ Ð¿Ð¾ÐºÑ€Ñ‹Ñ‚Ð¸ÐµÐ¼ (Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð´Ð»Ñ PR)
      - name: JaCoCo Code Coverage Report
        if: needs.event-info.outputs.event-type == 'pull_request'
        uses: madrapps/jacoco-report@v1.6.1
        with:
          paths: ./target/site/jacoco-aggregate/jacoco.xml
          token: ${{ secrets.GITHUB_TOKEN }}
          min-coverage-overall: 80
          min-coverage-changed-files: 75
          title: ðŸ“Š Code Coverage Report
          update-comment: true
          # Ð”Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Ð¾Ñ‚Ñ‡ÐµÑ‚Ð°
          pass-emoji: 'âœ…'
          fail-emoji: 'âŒ'

      # ðŸ—‚ï¸ Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ðµ Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚Ð¾Ð²
      - name: Upload test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-reports
          path: |
            **/target/surefire-reports/**/*
            **/target/failsafe-reports/**/*
            **/target/site/jacoco/**/*
            **/target/site/jacoco-aggregate/**/*
            **/target/allure-report-unit/**/*
          if-no-files-found: ignore

  # ðŸ Ð˜Ñ‚Ð¾Ð³Ð¾Ð²Ñ‹Ð¹ ÑÑ‚Ð°Ñ‚ÑƒÑ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸
  final-status:
    runs-on: ubuntu-latest
    needs: [event-info, quick-checks, tests-and-coverage]
    if: always()

    steps:
      - name: Final Check Status
        run: |
          echo "::group::ðŸ Final Status Summary"

          EVENT_TYPE="${{ needs.event-info.outputs.event-type }}"
          QUICK_STATUS="${{ needs.quick-checks.result }}"
          TEST_STATUS="${{ needs.tests-and-coverage.result }}"

          echo "ðŸ“‹ Check Summary:"
          echo "  Event type: $EVENT_TYPE"
          echo "  âš¡ Quick checks: $QUICK_STATUS"
          echo "  ðŸ§ª Tests & coverage: $TEST_STATUS"

          if [[ "$QUICK_STATUS" == "success" && "$TEST_STATUS" == "success" ]]; then
            echo ""
            echo "âœ… All checks passed successfully!"
            if [[ "$EVENT_TYPE" == "pull_request" ]]; then
              echo "PR is ready for review and merge."
            else
              echo "Push validation completed successfully."
            fi
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo ""
            echo "âŒ Some checks failed"
            if [[ "$EVENT_TYPE" == "pull_request" ]]; then
              echo "PR requires fixes before merge."
            else
              echo "Push validation failed - please check the issues."
            fi
            echo "status=failure" >> $GITHUB_OUTPUT
            exit 1
          fi

          echo "::endgroup::"

      # ðŸ“Š Summary Ð´Ð»Ñ GitHub
      - name: Job Summary
        if: always()
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## ðŸ” Code Quality Check Results

          | Check | Status |
          |-------|--------|
          | âš¡ Quick Checks (Compile + Checkstyle) | ${{ needs.quick-checks.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |
          | ðŸ§ª Tests & Coverage | ${{ needs.tests-and-coverage.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |

          ### ðŸ“‹ Event Details
          - **Type**: ${{ needs.event-info.outputs.event-type }}
          - **Branch**: ${{ needs.event-info.outputs.target-branch }}
          - **Commit**: `${{ github.sha }}`

          ### ðŸ“Š Coverage Thresholds
          - **Overall coverage**: 80%
          - **Changed files coverage**: 75%
          EOF
