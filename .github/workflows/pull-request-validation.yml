# ðŸ” Pull Request Validation - ÐŸÐ¾Ð»Ð½Ð°Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ° ÐºÐ°Ñ‡ÐµÑÑ‚Ð²Ð° ÐºÐ¾Ð´Ð° Ð¿ÐµÑ€ÐµÐ´ Ð¼ÐµÑ€Ð¶ÐµÐ¼
#
# Ð’Ñ‹Ð¿Ð¾Ð»Ð½ÑÐµÑ‚ Ð²ÑÐµ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ñ‹Ðµ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ Ð´Ð»Ñ PR:
# - ÐšÐ¾Ð¼Ð¿Ð¸Ð»ÑÑ†Ð¸Ñ Ñ Ð²Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸ÐµÐ¹ ÑÑ‚Ð¸Ð»Ñ ÐºÐ¾Ð´Ð° (Checkstyle)
# - Ð’Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ðµ Ð²ÑÐµÑ… Ñ‚ÐµÑÑ‚Ð¾Ð² Ñ Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸ÐµÐ¹ Ð¿Ð¾ÐºÑ€Ñ‹Ñ‚Ð¸Ñ
# - ÐŸÑƒÐ±Ð»Ð¸ÐºÐ°Ñ†Ð¸Ñ Ð¾Ñ‚Ñ‡ÐµÑ‚Ð¾Ð² Ð¾ Ñ‚ÐµÑÑ‚Ð°Ñ… Ð¸ Ð¿Ð¾ÐºÑ€Ñ‹Ñ‚Ð¸Ð¸ Ð² ÐºÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð°Ñ€Ð¸ÑÑ… PR
# - Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚Ð¾Ð² Ð´Ð»Ñ Ð°Ð½Ð°Ð»Ð¸Ð·Ð°
#
# Ð¢Ñ€Ð¸Ð³Ð³ÐµÑ€Ñ‹: ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ðµ/Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ PR Ð² Ð¾ÑÐ½Ð¾Ð²Ð½Ñ‹Ðµ Ð²ÐµÑ‚ÐºÐ¸
name: Pull Request Validation

on:
  pull_request:
    branches:
      - main
      - master
      - develop
      - 'dev/**'
      - 'release/**'

jobs:
  # ðŸ“‹ ÐÐ½Ð°Ð»Ð¸Ð· Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ð¸ Ð¾ PR
  pr-context-analysis:
    name: ðŸ“‹ Analyze PR Context
    runs-on: ubuntu-latest
    environment: dev
    outputs:
      pr-number: ${{ github.event.number }}
      source-branch: ${{ github.head_ref }}
      target-branch: ${{ github.base_ref }}
      author: ${{ github.event.pull_request.user.login }}

    steps:
      - name: Display PR Information
        run: |
          echo "ðŸ” Pull Request Validation Started"
          echo "ðŸ“ PR #${{ github.event.number }}"
          echo "ðŸ”€ ${{ github.head_ref }} â†’ ${{ github.base_ref }}"
          echo "ðŸ‘¤ Author: ${{ github.event.pull_request.user.login }}"
          echo "ðŸ“Š Files changed: ${{ github.event.pull_request.changed_files }}"

  # âš¡ Ð‘Ñ‹ÑÑ‚Ñ€Ñ‹Ðµ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸: ÐºÐ¾Ð¼Ð¿Ð¸Ð»ÑÑ†Ð¸Ñ + Ð²Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ñ ÑÑ‚Ð¸Ð»Ñ
  code-quality-validation:
    name: âš¡ Code Quality & Compilation
    runs-on: ubuntu-latest
    environment: dev
    needs: pr-context-analysis

    steps:
      - name: Checkout PR Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup JDK 24
        uses: actions/setup-java@v4
        with:
          java-version: '24'
          distribution: 'temurin'
          cache: maven

      - name: Validate Code Style & Compile
        run: |
          echo "::group::ðŸ—ï¸ Code Style Validation & Compilation"
          echo "Running Checkstyle validation and project compilation..."
          mvn clean compile -P prod-like-track -B -Dskip.sonar=true
          echo "::endgroup::"

      - name: Upload Code Style Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pr-${{ needs.pr-context-analysis.outputs.pr-number }}-checkstyle-results
          path: '**/target/checkstyle-result.xml'
          if-no-files-found: ignore

  # ðŸ§ª ÐŸÐ¾Ð»Ð½Ð¾Ðµ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ñ Ð¿Ð¾ÐºÑ€Ñ‹Ñ‚Ð¸ÐµÐ¼ ÐºÐ¾Ð´Ð°
  comprehensive-testing:
    name: ðŸ§ª Tests & Coverage Analysis
    runs-on: ubuntu-latest
    environment: dev
    needs: [pr-context-analysis, code-quality-validation]

    steps:
      - name: Checkout PR Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup JDK 24
        uses: actions/setup-java@v4
        with:
          java-version: '24'
          distribution: 'temurin'
          cache: maven

      - name: Execute Test Suite with Coverage
        run: |
          echo "::group::ðŸ§ª Running Full Test Suite"
          echo "Executing unit & integration tests with JaCoCo coverage..."
          mvn clean verify -P prod-like-track -B \
            -Djacoco.halt.on.failure=false -Dskip.sonar=true
          echo "::endgroup::"

      - name: Publish Test Results to PR
        uses: dorny/test-reporter@v1
        if: always()
        with:
          name: ðŸ§ª Maven Test Results (PR #${{ needs.pr-context-analysis.outputs.pr-number }})
          token: ${{ secrets.GITHUB_TOKEN }}
          path: '**/target/surefire-reports/*.xml,**/target/failsafe-reports/*.xml'
          reporter: java-junit
          fail-on-error: false

      - name: Upload Coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          file: ./target/site/jacoco-aggregate/jacoco.xml
          flags: pr-validation,unittests
          name: pr-${{ needs.pr-context-analysis.outputs.pr-number }}-coverage
          fail_ci_if_error: false
          verbose: true

      - name: Generate Coverage Report for PR Comment
        if: always()
        uses: madrapps/jacoco-report@v1.6.1
        with:
          paths: ./target/site/jacoco-aggregate/jacoco.xml
          token: ${{ secrets.GITHUB_TOKEN }}
          min-coverage-overall: 80
          min-coverage-changed-files: 75
          title: ðŸ“Š Code Coverage Report (PR #${{ needs.pr-context-analysis.outputs.pr-number }})
          update-comment: true
          pass-emoji: 'âœ…'
          fail-emoji: 'âŒ'

      - name: Archive Test & Coverage Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pr-${{ needs.pr-context-analysis.outputs.pr-number }}-test-coverage-reports
          path: |
            **/target/surefire-reports/**/*
            **/target/failsafe-reports/**/*
            **/target/site/jacoco/**/*
            **/target/site/jacoco-aggregate/**/*
          if-no-files-found: ignore

  # ðŸ Ð˜Ñ‚Ð¾Ð³Ð¾Ð²Ð°Ñ Ð¾Ñ†ÐµÐ½ÐºÐ° Ð³Ð¾Ñ‚Ð¾Ð²Ð½Ð¾ÑÑ‚Ð¸ PR Ðº Ð¼ÐµÑ€Ð¶Ñƒ
  pr-readiness-assessment:
    name: ðŸ PR Readiness Assessment
    runs-on: ubuntu-latest
    needs: [pr-context-analysis, code-quality-validation, comprehensive-testing]
    if: always()

    steps:
      - name: Evaluate PR Readiness
        run: |
          echo "::group::ðŸ Pull Request Readiness Assessment"

          PR_NUMBER="${{ needs.pr-context-analysis.outputs.pr-number }}"
          QUALITY_STATUS="${{ needs.code-quality-validation.result }}"
          TESTING_STATUS="${{ needs.comprehensive-testing.result }}"

          echo "ðŸ“Š Validation Summary for PR #$PR_NUMBER:"
          echo "  âš¡ Code Quality & Compilation: $QUALITY_STATUS"
          echo "  ðŸ§ª Tests & Coverage: $TESTING_STATUS"

          if [[ "$QUALITY_STATUS" == "success" && "$TESTING_STATUS" == "success" ]]; then
            echo ""
            echo "âœ… PR #$PR_NUMBER is READY for review and merge!"
            echo "All quality gates passed successfully."
            echo "status=ready-for-merge" >> $GITHUB_OUTPUT
          else
            echo ""
            echo "âŒ PR #$PR_NUMBER requires FIXES before merge"
            echo "Please address the failing checks before requesting review."
            echo "status=requires-fixes" >> $GITHUB_OUTPUT
            exit 1
          fi

          echo "::endgroup::"

      - name: Generate PR Summary
        if: always()
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## ðŸ” Pull Request Validation Results

          ### ðŸ“‹ PR Details
          - **PR Number**: #${{ needs.pr-context-analysis.outputs.pr-number }}
          - **Source**: `${{ needs.pr-context-analysis.outputs.source-branch }}`
          - **Target**: `${{ needs.pr-context-analysis.outputs.target-branch }}`
          - **Author**: @${{ needs.pr-context-analysis.outputs.author }}

          ### ðŸŽ¯ Quality Gates
          | Check | Status | Details |
          |-------|---------|---------|
          | âš¡ Code Quality & Compilation | ${{ needs.code-quality-validation.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} | Checkstyle validation & compilation |
          | ðŸ§ª Tests & Coverage | ${{ needs.comprehensive-testing.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} | Unit/integration tests with coverage |

          ### ðŸ“Š Coverage Requirements
          - **Overall Coverage**: â‰¥ 80%
          - **Changed Files Coverage**: â‰¥ 75%

          ### ðŸŽ‰ Next Steps
          ${{ (needs.code-quality-validation.result == 'success' && needs.comprehensive-testing.result == 'success') && 'âœ… **Ready for Review** - All checks passed! You can request code review.' || 'âŒ **Requires Fixes** - Please address failing checks before requesting review.' }}
          EOF
