# ðŸš€ Main Branch CI - ÐŸÐ¾ÑÑ‚-Ð¼ÐµÑ€Ð¶ Ð²Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ñ Ð¸ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¼ÐµÑ‚Ñ€Ð¸Ðº
#
# Ð’Ñ‹Ð¿Ð¾Ð»Ð½ÑÐµÑ‚ÑÑ Ð¿Ð¾ÑÐ»Ðµ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾Ð³Ð¾ Ð¼ÐµÑ€Ð¶Ð° PR Ð² Ð¾ÑÐ½Ð¾Ð²Ð½Ñ‹Ðµ Ð²ÐµÑ‚ÐºÐ¸:
# - Ð‘Ñ‹ÑÑ‚Ñ€Ð°Ñ ÐºÐ¾Ð¼Ð¿Ð¸Ð»ÑÑ†Ð¸Ð¾Ð½Ð½Ð°Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ†ÐµÐ»Ð¾ÑÑ‚Ð½Ð¾ÑÑ‚Ð¸
# - ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ coverage badge Ð´Ð»Ñ Ð¾ÑÐ½Ð¾Ð²Ð½Ð¾Ð¹ Ð²ÐµÑ‚ÐºÐ¸
# - Ð£Ð²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ñ Ð¾Ð± ÑƒÑÐ¿ÐµÑˆÐ½Ð¾Ð¼ Ð´ÐµÐ¿Ð»Ð¾Ðµ (Ð¿Ñ€Ð¸ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ð¾ÑÑ‚Ð¸)
#
# Ð¢Ñ€Ð¸Ð³Ð³ÐµÑ€Ñ‹: push Ð² main/master Ð²ÐµÑ‚ÐºÐ¸ (Ð¾Ð±Ñ‹Ñ‡Ð½Ð¾ Ð¿Ð¾ÑÐ»Ðµ Ð¼ÐµÑ€Ð¶Ð° PR)
name: Main Branch CI

on:
  push:
    branches:
      - main
      - master

env:
  MAIN_BRANCH_NAME: ${{ github.ref_name }}

jobs:
  # ðŸ“‹ ÐÐ½Ð°Ð»Ð¸Ð· ÐºÐ¾Ð½Ñ‚ÐµÐºÑÑ‚Ð° Ð¾ÑÐ½Ð¾Ð²Ð½Ð¾Ð¹ Ð²ÐµÑ‚ÐºÐ¸
  main-branch-context:
    name: ðŸ“‹ Main Branch Context
    runs-on: ubuntu-latest
    outputs:
      branch-name: ${{ github.ref_name }}
      commit-sha: ${{ github.sha }}
      is-merge-commit: ${{ contains(github.event.head_commit.message, 'Merge pull request') }}

    steps:
      - name: Display Branch Information
        run: |
          echo "ðŸš€ Main Branch CI Pipeline Started"
          echo "ðŸŒ³ Branch: ${{ github.ref_name }}"
          echo "ðŸ“ Commit: ${{ github.sha }}"
          echo "ðŸ‘¤ Author: ${{ github.event.head_commit.author.name }}"
          echo "ðŸ’¬ Message: ${{ github.event.head_commit.message }}"
          echo "ðŸ”„ Is merge commit: ${{ contains(github.event.head_commit.message, 'Merge pull request') }}"

  # âš¡ Ð‘Ñ‹ÑÑ‚Ñ€Ð°Ñ Ð²Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ñ Ñ†ÐµÐ»Ð¾ÑÑ‚Ð½Ð¾ÑÑ‚Ð¸ Ð¿Ð¾ÑÐ»Ðµ Ð¼ÐµÑ€Ð¶Ð°
  post-merge-integrity-check:
    name: âš¡ Post-Merge Integrity Check
    runs-on: ubuntu-latest
    environment: production
    needs: main-branch-context

    steps:
      - name: Checkout Main Branch
        uses: actions/checkout@v4

      - name: Setup JDK 24
        uses: actions/setup-java@v4
        with:
          java-version: '24'
          distribution: 'temurin'
          cache: maven

      - name: Verify Main Branch Integrity
        run: |
          echo "::group::âš¡ Verifying main branch integrity"
          echo "Performing quick compilation check to ensure merge didn't break build..."
          mvn clean compile -B -q
          echo "âœ… Main branch integrity verified successfully"
          echo "::endgroup::"

  # ðŸ“Š ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¼ÐµÑ‚Ñ€Ð¸Ðº Ð¿Ð¾ÐºÑ€Ñ‹Ñ‚Ð¸Ñ Ð´Ð»Ñ Ð¾ÑÐ½Ð¾Ð²Ð½Ð¾Ð¹ Ð²ÐµÑ‚ÐºÐ¸
  coverage-metrics-update:
    name: ðŸ“Š Update Coverage Metrics
    runs-on: ubuntu-latest
    environment: production
    needs: [main-branch-context, post-merge-integrity-check]

    steps:
      - name: Checkout Main Branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup JDK 24
        uses: actions/setup-java@v4
        with:
          java-version: '24'
          distribution: 'temurin'
          cache: maven

      - name: Generate Coverage Report for Main Branch
        run: |
          echo "::group::ðŸ“Š Generating coverage report for main branch"
          echo "Running tests and generating coverage for badge update..."
          mvn clean verify -B -q \
            -Dskip.checkstyle=true \
            -Djacoco.halt.on.failure=false
          echo "::endgroup::"

      - name: Update Main Branch Coverage in Codecov
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          file: ./target/site/jacoco-aggregate/jacoco.xml
          flags: main-branch,production
          name: main-branch-coverage
          fail_ci_if_error: false
          verbose: false

      - name: Archive Main Branch Coverage Report
        uses: actions/upload-artifact@v4
        with:
          name: main-branch-${{ needs.main-branch-context.outputs.commit-sha }}-coverage
          path: '**/target/site/jacoco-aggregate/**/*'
          if-no-files-found: ignore
          retention-days: 30

  # ðŸ Ð˜Ñ‚Ð¾Ð³Ð¾Ð²Ñ‹Ð¹ ÑÑ‚Ð°Ñ‚ÑƒÑ CI Ð¾ÑÐ½Ð¾Ð²Ð½Ð¾Ð¹ Ð²ÐµÑ‚ÐºÐ¸
  main-branch-ci-summary:
    name: ðŸ Main Branch CI Summary
    runs-on: ubuntu-latest
    needs: [main-branch-context, post-merge-integrity-check, coverage-metrics-update]
    if: always()

    steps:
      - name: Generate CI Summary
        run: |
          echo "::group::ðŸ Main Branch CI Summary"

          BRANCH="${{ needs.main-branch-context.outputs.branch-name }}"
          INTEGRITY_STATUS="${{ needs.post-merge-integrity-check.result }}"
          COVERAGE_STATUS="${{ needs.coverage-metrics-update.result }}"
          IS_MERGE="${{ needs.main-branch-context.outputs.is-merge-commit }}"

          echo "ðŸ“Š Main Branch CI Results for: $BRANCH"
          echo "  âš¡ Post-merge integrity: $INTEGRITY_STATUS"
          echo "  ðŸ“Š Coverage metrics update: $COVERAGE_STATUS"

          if [[ "$INTEGRITY_STATUS" == "success" && "$COVERAGE_STATUS" == "success" ]]; then
            echo ""
            echo "âœ… Main branch CI completed successfully!"
            echo "ðŸŽ‰ $BRANCH is ready for production deployment"
            [[ "$IS_MERGE" == "true" ]] && echo "ðŸ”„ Processed merge commit successfully"
          else
            echo ""
            echo "âŒ Main branch CI encountered issues"
            echo "ðŸš¨ Immediate attention required for $BRANCH"
            exit 1
          fi

          echo "::endgroup::"

      - name: Create Deployment Summary
        if: always()
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## ðŸš€ Main Branch CI Results

          ### ðŸŒ³ Branch Information
          - **Branch**: `${{ needs.main-branch-context.outputs.branch-name }}`
          - **Commit**: `${{ needs.main-branch-context.outputs.commit-sha }}`
          - **Merge Commit**: ${{ needs.main-branch-context.outputs.is-merge-commit == 'true' && 'âœ… Yes' || 'âŒ No' }}

          ### ðŸŽ¯ CI Pipeline Results
          | Step | Status | Description |
          |------|---------|-------------|
          | âš¡ Integrity Check | ${{ needs.post-merge-integrity-check.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} | Post-merge build verification |
          | ðŸ“Š Coverage Update | ${{ needs.coverage-metrics-update.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} | Coverage metrics and badge update |

          ### ðŸš€ Deployment Status
          ${{ (needs.post-merge-integrity-check.result == 'success' && needs.coverage-metrics-update.result == 'success') && 'âœ… **Ready for Production** - All CI checks passed successfully!' || 'âŒ **Deployment Blocked** - CI issues detected, deployment should be postponed.' }}

          ### ðŸ”— Useful Links
          - [ðŸ“Š Coverage Report](https://codecov.io/gh/ekgreen/star-boot/branch/${{ needs.main-branch-context.outputs.branch-name }})
          - [ðŸ—ï¸ Build Artifacts](https://github.com/ekgreen/star-boot/actions/runs/${{ github.run_id }})
          EOF
